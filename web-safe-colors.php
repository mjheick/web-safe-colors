<?php

/* 216 web-safe colors from https://htmlcolorcodes.com/color-chart/web-safe-color-chart/ */
$colors = [
	[0, 0, 0], [0, 0, 102], [0, 0, 153], [0, 0, 204], [0, 0, 255], [0, 0, 51], [0, 102, 0], [0, 102, 102], [0, 102, 153], [0, 102, 204], [0, 102, 255], [0, 102, 51],
	[0, 153, 0], [0, 153, 102], [0, 153, 153], [0, 153, 204], [0, 153, 255], [0, 153, 51], [0, 204, 0], [0, 204, 102], [0, 204, 153], [0, 204, 204], [0, 204, 255], [0, 204, 51],
	[0, 255, 0], [0, 255, 102], [0, 255, 153], [0, 255, 204], [0, 255, 255], [0, 255, 51], [0, 51, 0], [0, 51, 102], [0, 51, 153], [0, 51, 204], [0, 51, 255], [0, 51, 51],
	[102, 0, 0], [102, 0, 102], [102, 0, 153], [102, 0, 204], [102, 0, 255], [102, 0, 51], [102, 102, 0], [102, 102, 102], [102, 102, 153], [102, 102, 204], [102, 102, 255], [102, 102, 51],
	[102, 153, 0], [102, 153, 102], [102, 153, 153], [102, 153, 204], [102, 153, 255], [102, 153, 51], [102, 204, 0], [102, 204, 102], [102, 204, 153], [102, 204, 204], [102, 204, 255], [102, 204, 51],
	[102, 255, 0], [102, 255, 102], [102, 255, 153], [102, 255, 204], [102, 255, 255], [102, 255, 51], [102, 51, 0], [102, 51, 102], [102, 51, 153], [102, 51, 204], [102, 51, 255], [102, 51, 51],
	[153, 0, 0], [153, 0, 102], [153, 0, 153], [153, 0, 204], [153, 0, 255], [153, 0, 51], [153, 102, 0], [153, 102, 102], [153, 102, 153], [153, 102, 204], [153, 102, 255], [153, 102, 51],
	[153, 153, 0], [153, 153, 102], [153, 153, 153], [153, 153, 204], [153, 153, 255], [153, 153, 51], [153, 204, 0], [153, 204, 102], [153, 204, 153], [153, 204, 204], [153, 204, 255], [153, 204, 51],
	[153, 255, 0], [153, 255, 102], [153, 255, 153], [153, 255, 204], [153, 255, 255], [153, 255, 51], [153, 51, 0], [153, 51, 102], [153, 51, 153], [153, 51, 204], [153, 51, 255], [153, 51, 51],
	[204, 0, 0], [204, 0, 102], [204, 0, 153], [204, 0, 204], [204, 0, 255], [204, 0, 51], [204, 102, 0], [204, 102, 102], [204, 102, 153], [204, 102, 204], [204, 102, 255], [204, 102, 51],
	[204, 153, 0], [204, 153, 102], [204, 153, 153], [204, 153, 204], [204, 153, 255], [204, 153, 51], [204, 204, 0], [204, 204, 102], [204, 204, 153], [204, 204, 204], [204, 204, 255], [204, 204, 51],
	[204, 255, 0], [204, 255, 102], [204, 255, 153], [204, 255, 204], [204, 255, 255], [204, 255, 51], [204, 51, 0], [204, 51, 102], [204, 51, 153], [204, 51, 204], [204, 51, 255], [204, 51, 51],
	[255, 0, 0], [255, 0, 102], [255, 0, 153], [255, 0, 204], [255, 0, 255], [255, 0, 51], [255, 102, 0], [255, 102, 102], [255, 102, 153], [255, 102, 204], [255, 102, 255], [255, 102, 51],
	[255, 153, 0], [255, 153, 102], [255, 153, 153], [255, 153, 204], [255, 153, 255], [255, 153, 51], [255, 204, 0], [255, 204, 102], [255, 204, 153], [255, 204, 204], [255, 204, 255], [255, 204, 51],
	[255, 255, 0], [255, 255, 102], [255, 255, 153], [255, 255, 204], [255, 255, 255], [255, 255, 51], [255, 51, 0], [255, 51, 102], [255, 51, 153], [255, 51, 204], [255, 51, 255], [255, 51, 51],
	[51, 0, 0], [51, 0, 102], [51, 0, 153], [51, 0, 204], [51, 0, 255], [51, 0, 51], [51, 102, 0], [51, 102, 102], [51, 102, 153], [51, 102, 204], [51, 102, 255], [51, 102, 51],
	[51, 153, 0], [51, 153, 102], [51, 153, 153], [51, 153, 204], [51, 153, 255], [51, 153, 51], [51, 204, 0], [51, 204, 102], [51, 204, 153], [51, 204, 204], [51, 204, 255], [51, 204, 51],
	[51, 255, 0], [51, 255, 102], [51, 255, 153], [51, 255, 204], [51, 255, 255], [51, 255, 51], [51, 51, 0], [51, 51, 102], [51, 51, 153], [51, 51, 204], [51, 51, 255], [51, 51, 51],
];

$input = $argv[1] ?? null;
$output = $argv[2] ?? 'output.png';
if (is_null($input)) { die('parameter 1 needs to be an image file' ."\n"); }
if (!file_exists($input)) { die('file ' . $input . ' not found' . "\n"); }

$i = imagecreatefromstring(file_get_contents($input));
$o = imagecreatetruecolor(imagesx($i), imagesy($i));

for ($y = 0; $y < imagesy($i); $y++) {
	for ($x = 0; $x < imagesx($i); $x++) {
		$clr = imagecolorat($i, $x, $y);
		$red = ($clr >> 16) & 0xFF;
		$grn = ($clr >> 8) & 0xFF;
		$blu = $clr & 0xFF;
		$distance = 256;
		$new_clr = 0;
		foreach ($colors as $clr_rgb) {
			$clr_distance = sqrt(pow($clr_rgb[0] - $red, 2) + pow($clr_rgb[1] - $grn, 2) + pow($clr_rgb[2] - $blu, 2));
			if ($clr_distance < $distance) {
				$distance = $clr_distance;
				$new_clr = ($clr_rgb[0] << 16) + ($clr_rgb[1] << 8) + $clr_rgb[2];
			}
		}
		imagesetpixel($o, $x, $y, $new_clr);		
	}
}
imagedestroy($i);
imagepng($o, $output);
